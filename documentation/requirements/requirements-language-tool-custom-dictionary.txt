================================================================================
FEATURE: Global Dictionary for Spelling Whitelist
================================================================================

OVERVIEW
--------
Add a global dictionary feature to whitelist words that LanguageTool incorrectly
flags as spelling errors. Common use cases: proper nouns, brand names, technical
terms, geographic names.

PROBLEM
-------
LanguageTool flags legitimate words as spelling errors (e.g., "Coconino",
"ReleasePass", client brand names). Currently no way to suppress these globally.
Existing IgnoredRule only works per-URL.

SOLUTION
--------
Application-side filtering with a database-backed whitelist. Words marked as
active (isActive: true) are filtered out of spelling results before storing ResultItems.

Why application-side (not LanguageTool config):
- Fully dynamic - add/remove words instantly without container restart
- Manageable via web UI
- No Docker image rebuilds
- Negligible performance impact (~20ms vs 1-5s LanguageTool API call)

================================================================================
DECISIONS
================================================================================

1. SCOPE: Global dictionary (not project-scoped)
   - Proper nouns are universal
   - Simpler to manage
   - Can add project/company override later if needed

2. ACTIVE STATE: Boolean field
   - isActive: true = word IS filtered from spelling results
   - isActive: false = word is stored but NOT filtered (inactive)

3. ENTRY POINTS:
   - Settings > Custom Dictionary: Manual add (defaults to isActive: true)
   - Spelling result "Ignore": Silent add to dictionary as isActive: false + IgnoredRule

4. UI LOCATION: Settings > Custom Dictionary (tab after Preflight Categories)
   - Admin only (when roles are introduced)

5. DUPLICATES: Show error "Word already exists" with link to edit
   - Bulk add: Skip duplicates silently, show summary

6. SEED WORDS: None - dictionary starts empty
   - Words are populated manually or via Spelling Ignore action

7. WORD VALIDATION:
   - Minimum: 2 characters
   - Maximum: 45 characters
   - Allowed: Unicode letters (including accented: é, ü, ñ), numbers, hyphens, apostrophes
   - Apostrophes: Normalize curly (') to straight (') on input
   - No spaces: Input with spaces is split into multiple words

8. MATCHING: Exact lowercase match (no normalization of special characters)

9. SEARCH: Contains match (e.g., "con" matches "Coconino")

10. RETROACTIVE: Whitelisting is prospective only. Existing ResultItems are not
   updated. Users must rerun spelling tests to apply new whitelist entries.

================================================================================
DATA SCHEMA
================================================================================

model DictionaryWord {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  word            String   @unique  // Lowercase for matching (2-45 chars)
  displayWord     String   // Original casing for display

  isActive        Boolean  @default(true)  // true = filtered from results

  // Origin tracking (stored, not displayed in MVP)
  source          DictionaryWordSource @default(MANUAL)
  sourceUrl       String?  // URL where first flagged (if source=RESULT)

  // Audit (stored, not displayed in MVP)
  createdByUserId String?  @db.Uuid
  createdBy       User?    @relation(fields: [createdByUserId], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([word])  // For search
}

enum DictionaryWordSource {
  MANUAL  // Added via Settings > Custom Dictionary
  RESULT  // Added via Ignore on spelling result
}

================================================================================
UI SPECIFICATION
================================================================================

--------------------------------------------------------------------------------
SETTINGS > CUSTOM DICTIONARY (List View)
--------------------------------------------------------------------------------

Location: Settings navigation, new tab after "Preflight Categories"
Route: /settings/dictionary

Table Columns:
+------------+-----------------+----------+---------------------+---------+
| Word       | Source          | Added By | Date Added          | Active  | Actions |
+------------+-----------------+----------+---------------------+---------+---------+
| Coconino   | Manual          | user@... | Jan 15, 2025 2:30pm | Yes     | [Edit]  |
| Acme       | Spelling Ignore | user@... | Jan 14, 2025 9:15am | No      | [Edit]  |
| iPhone     | Manual          | System   | Jan 1, 2025 12:00pm | Yes     | [Edit]  |
+------------+-----------------+----------+---------------------+---------+---------+

Features:
- Filter: Dropdown (All / Active / Inactive)
- Search: Server-side search, partial match on word field
- Sort: Alphabetical by word (default)
- Pagination: 50 items per page, server-side
- Show count: "47 words" or "Showing 1-50 of 234 words"

Add Word Button: Opens modal

--------------------------------------------------------------------------------
ADD WORD MODAL
--------------------------------------------------------------------------------

+--------------------------------------------------+
| Add Dictionary Words                             |
+--------------------------------------------------+
| Enter words (one per line):                      |
|                                                  |
| +----------------------------------------------+ |
| | Coconino                                     | |
| | ReleasePass                                  | |
| | Acme                                         | |
| |                                              | |
| +----------------------------------------------+ |
|                                                  |
| [x] Active                                       |
|                                                  |
|              [Cancel]  [Add Words]               |
+--------------------------------------------------+

Behavior:
- Textarea accepts multiple words, one per line
- Words containing spaces are split into multiple entries
- "Active" checkbox defaults to checked (isActive: true)
- On submit:
  - Trim whitespace, filter empty lines
  - Split any words containing spaces
  - Validate each word (2-45 chars, allowed characters only)
  - Store word as lowercase, displayWord as original
  - Skip duplicates silently
  - Show summary: "Added 12 words. 3 already existed (skipped)."
- Single word that already exists: Show error with link to edit
- Validation errors: Show which words failed and why

--------------------------------------------------------------------------------
EDIT WORD MODAL
--------------------------------------------------------------------------------

+--------------------------------------------------+
| Edit Dictionary Word                             |
+--------------------------------------------------+
| Word: [Coconino________________]                 |
|                                                  |
| [x] Active                                       |
|                                                  |
|   [Delete]         [Cancel]  [Save Changes]      |
+--------------------------------------------------+

Fields:
- Word: Text input (editable, validated same as add)
- Active: Checkbox (checked = isActive: true)
- Delete button with confirmation

--------------------------------------------------------------------------------
SPELLING RESULT - IGNORE ACTION (Enhancement)
--------------------------------------------------------------------------------

Current behavior when clicking "Ignore" on a spelling error:
- Creates IgnoredRule for that URL + rule code

New behavior (handled server-side in existing Ignore API):
1. Creates IgnoredRule (existing behavior, unchanged)
2. For misspelling-type errors only, SILENTLY creates DictionaryWord with:
   - word: extracted from ResultItem.meta (lowercase)
   - displayWord: original casing
   - isActive: false (inactive until manually activated)
   - source: RESULT
   - sourceUrl: current URL
   - createdByUserId: current user
3. If word already exists in dictionary: Skip silently (still create IgnoredRule)
4. If dictionary add fails: Log warning, don't fail the Ignore action

Identification of misspelling errors:
- provider === 'LANGUAGETOOL'
- meta.issueType === 'misspelling' OR meta.category === 'TYPOS'

Word extraction from ResultItem.meta:
- meta.context.substring(meta.contextOffset, meta.contextOffset + meta.contextLength)

UI shows: "Ignored" confirmation (no mention of dictionary - silent seeding)

================================================================================
WORKER IMPLEMENTATION
================================================================================

File: worker/providers/spelling/index.ts

--------------------------------------------------------------------------------
WHITELIST CACHING
--------------------------------------------------------------------------------

// Cache at module level, refresh periodically
let whitelistCache: Set<string> | null = null;
let whitelistLoadedAt: number = 0;
const WHITELIST_CACHE_TTL_MS = 60_000; // 1 minute

async function getWhitelist(): Promise<Set<string>> {
  const now = Date.now();
  if (!whitelistCache || (now - whitelistLoadedAt) > WHITELIST_CACHE_TTL_MS) {
    const words = await prisma.dictionaryWord.findMany({
      where: { isActive: true },
      select: { word: true }
    });
    whitelistCache = new Set(words.map(w => w.word));
    whitelistLoadedAt = now;
    console.log(`[SPELLING] Loaded ${whitelistCache.size} active dictionary words`);
  }
  return whitelistCache;
}

--------------------------------------------------------------------------------
FILTERING LOGIC
--------------------------------------------------------------------------------

In checkUrlSpelling() after getting LanguageTool results and before creating
ResultItems, add whitelist filtering:

// Get whitelist
const whitelist = await getWhitelist();

// Filter matches against whitelist
const whitelistedMatches: SpellingMatch[] = [];
const remainingMatches: SpellingMatch[] = [];

for (const match of filteredMatches) {
  const word = extractMatchWord(match).toLowerCase();
  if (whitelist.has(word)) {
    whitelistedMatches.push(match);
  } else {
    remainingMatches.push(match);
  }
}

// Log filtered words
if (whitelistedMatches.length > 0) {
  console.log(`[SPELLING] Filtered ${whitelistedMatches.length} whitelisted word(s):`);
  for (const match of whitelistedMatches) {
    console.log(`  - "${extractMatchWord(match)}"`);
  }
}

// Continue with remainingMatches instead of filteredMatches

--------------------------------------------------------------------------------
HELPER FUNCTION
--------------------------------------------------------------------------------

function extractMatchWord(match: SpellingMatch): string {
  return match.context.text.substring(
    match.context.offset,
    match.context.offset + match.context.length
  );
}

--------------------------------------------------------------------------------
RAW PAYLOAD TRACKING
--------------------------------------------------------------------------------

Add filtered whitelist words to rawPayload for debugging:

rawPayload.languagetool.push({
  url,
  issueCount: remainingMatches.length,
  wordCount: checkResult.wordCount,
  language: checkResult.language,
  filteredProperNouns: checkResult.filteredProperNouns,
  filteredWhitelistWords: whitelistedMatches.map(m => extractMatchWord(m)),  // NEW
});

================================================================================
API ENDPOINTS
================================================================================

--------------------------------------------------------------------------------
GET /api/dictionary
--------------------------------------------------------------------------------

Query params:
- isActive: 'true' | 'false' | undefined (all)
- search: string (partial match on word, server-side)
- page: number (default 1)
- limit: number (default 50)

Response:
{
  words: DictionaryWord[],
  pagination: { page, limit, total, totalPages }
}

--------------------------------------------------------------------------------
POST /api/dictionary
--------------------------------------------------------------------------------

Request body:
{
  words: string[],           // Array of words to add
  isActive?: boolean         // Default: true
}

Processing:
- Split any words containing spaces
- Validate each: 2-45 chars, allowed characters
- Skip invalid words (return in errors array)
- Skip duplicates silently

Response:
{
  added: number,
  skipped: number,           // Already existed
  errors: string[],          // Invalid words with reason
  words: DictionaryWord[]    // Newly created words
}

--------------------------------------------------------------------------------
GET /api/dictionary/[id]
--------------------------------------------------------------------------------

Response: DictionaryWord

--------------------------------------------------------------------------------
PUT /api/dictionary/[id]
--------------------------------------------------------------------------------

Request body:
{
  word?: string,
  isActive?: boolean
}

Response: DictionaryWord

Validation:
- Word must pass validation rules (2-45 chars, etc.)
- If word changed, check for duplicates

--------------------------------------------------------------------------------
DELETE /api/dictionary/[id]
--------------------------------------------------------------------------------

Response: { success: true }

--------------------------------------------------------------------------------
POST /api/dictionary/bulk (REMOVED)
--------------------------------------------------------------------------------

Bulk operations removed from MVP. Use individual edit for status changes.

================================================================================
SEED DATA (REMOVED)
================================================================================

No seed data - dictionary starts empty. Words are populated:
- Manually via Settings > Custom Dictionary
- Automatically (as inactive) via Spelling Ignore action

================================================================================
IMPLEMENTATION PHASES
================================================================================

PHASE 1: Database Schema
------------------------
- Add DictionaryWord model to schema.prisma
- Add enum DictionaryWordSource
- Run migration

PHASE 2: API Routes
-------------------
- GET /api/dictionary (list with server-side search + pagination)
- POST /api/dictionary (add words with validation)
- GET /api/dictionary/[id]
- PUT /api/dictionary/[id]
- DELETE /api/dictionary/[id]

PHASE 3: Settings UI
--------------------
- Add Custom Dictionary tab to Settings navigation
- List view with table, filters, server-side search, pagination
- Add Word modal (textarea, Active checkbox, validation feedback)
- Edit Word modal

PHASE 4: Worker Integration
---------------------------
- Add whitelist caching (filter by isActive: true)
- Add filtering logic after LanguageTool results
- Add logging for filtered words
- Add to rawPayload for debugging

PHASE 5: Ignore Enhancement
---------------------------
- Extend existing Ignore API route
- Extract word from ResultItem.meta
- Add silent DictionaryWord creation for misspelling errors (isActive: false)
- Graceful failure handling (log, don't block Ignore)

PHASE 6: Testing
----------------
- Unit tests for API routes
- Unit tests for word validation
- Test whitelist filtering in worker
- Test duplicate handling
- Test Ignore + dictionary add flow

================================================================================
FILE SUMMARY
================================================================================

New files:
- prisma/migrations/xxx_add_dictionary_word.sql
- app/api/dictionary/route.ts
- app/api/dictionary/[id]/route.ts
- app/(dashboard)/settings/dictionary/page.tsx
- components/ui/modal/Modal.tsx
- lib/dictionary-validation.ts (shared validation logic)

Modified files:
- prisma/schema.prisma (add model + enum)
- worker/providers/spelling/index.ts (whitelist filtering + rawPayload)
- app/api/result-items/[id]/route.ts (silent dictionary add on ignore)
- lib/constants/navigation.ts (add Custom Dictionary nav item)

================================================================================
PERFORMANCE NOTES
================================================================================

- Whitelist cached for 60 seconds in worker
- Single DB query per cache refresh (~5-20ms)
- String set lookup for each match (<1ms total)
- Total overhead: ~20ms per spelling run (negligible vs 1-5s LT call)

================================================================================
FUTURE ENHANCEMENTS
================================================================================

- Project or Company scoped dictionaries (override global)
- Bulk operations (activate/deactivate/delete multiple)
- Import/export dictionary as CSV
- Suggested words from common false positives
- Integration with LanguageTool's native dictionary (if API support added)
- Seed data script for common tech terms (optional bootstrap)