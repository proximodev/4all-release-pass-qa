// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"

  // TEMPORARY: Binary engine mode for Windows ARM64 compatibility
  // Prisma doesn't ship native ARM64 binaries for Windows, so we use binary mode
  // which runs the query engine as a separate process (works via Windows translation)
  //
  // TO REVERT (when ARM64 support no longer needed):
  //   1. Remove the line below (engineType = "binary")
  //   2. Run: npx prisma generate
  //   3. Restart dev server
  //
  // More info: https://github.com/prisma/prisma/issues/25206
  engineType = "binary"
}

/// ---- ENUMS ----

enum UserRole {
  ADMIN
}

enum TestType {
  PAGE_PREFLIGHT // Page-level SEO + link checking + custom rules
  SITE_AUDIT     // Full site crawl (site-level, v1.2)
  PERFORMANCE
  SCREENSHOTS
  SPELLING
}

enum TestStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

enum TestScope {
  SINGLE_URL
  CUSTOM_URLS
  SITEMAP
}

enum IssueProvider {
  SE_RANKING
  LANGUAGETOOL
  LIGHTHOUSE
  LINKINATOR
  ReleasePass
  INTERNAL
}

enum IssueSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
  BLOCKER
}

enum ScreenshotRole {
  CURRENT
  PREVIOUS
  BASELINE
}

enum ManualTestType {
  SCREENSHOTS
  SPELLING
}

enum ManualStatusLabel {
  PASS
  REVIEW
  FAIL
}

enum ReleaseRunStatus {
  PENDING
  READY
  FAIL
}

enum ResultStatus {
  PASS
  FAIL
  SKIP
}

/// ---- CORE ENTITIES ----

model Company {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String

  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId  String? @db.Uuid
  name       String
  siteUrl    String
  sitemapUrl String?
  notes      String?

  company        Company?              @relation(fields: [companyId], references: [id])
  releaseRuns    ReleaseRun[]
  testRuns       TestRun[]
  screenshotSets ScreenshotSet[]
  manualStatuses ManualTestStatus[]
  ignoredRules   IgnoredRule[]
  optionalRules  ProjectOptionalRule[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  @@index([companyId])
  @@index([siteUrl])
  @@index([deletedAt])
}

model User {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String   @unique
  firstName      String?
  lastName       String?
  role           UserRole @default(ADMIN)
  supabaseUserId String   @unique @db.Uuid

  manualTestStatuses ManualTestStatus[] @relation("ManualStatusUpdatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supabaseUserId])
}

/// A frozen snapshot representing a single launch candidate
model ReleaseRun {
  id                   String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId            String           @db.Uuid
  name                 String?          // Optional label (e.g., "v2.1 Launch", "December Release")
  status               ReleaseRunStatus @default(PENDING)
  urls                 Json             // Frozen string array: ["https://example.com/page1", "https://example.com/page2"]
  selectedTests        Json             // TestType array: ["PAGE_PREFLIGHT", "PERFORMANCE", "SCREENSHOTS", "SPELLING"]
  enabledOptionalRules Json?            // Frozen snapshot of enabled optional rule codes: ["EXTERNAL_LINK_TARGET", ...]

  project        Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testRuns       TestRun[]
  manualStatuses ManualTestStatus[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId, status])
  @@index([createdAt])
}

model TestRun {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  releaseRunId  String?    @db.Uuid // Nullable for site-level tests (SITE_AUDIT)
  projectId     String     @db.Uuid
  type          TestType
  status        TestStatus @default(QUEUED)
  score         Int? // 0-100 for Site Audit & Performance, null for Screenshots/Spelling
  startedAt     DateTime?
  finishedAt    DateTime?
  lastHeartbeat DateTime? // Worker updates every 30s to detect stuck runs
  rawPayload    Json?
  error         String?

  releaseRun     ReleaseRun?     @relation(fields: [releaseRunId], references: [id], onDelete: Cascade)
  project        Project         @relation(fields: [projectId], references: [id])
  urlResults     UrlResult[]
  screenshotSets ScreenshotSet[]
  config         TestRunConfig?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([releaseRunId])
  @@index([releaseRunId, type])
  @@index([releaseRunId, status])
  @@index([projectId, type, createdAt])
  @@index([status, createdAt])
}

model TestRunConfig {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  testRunId String    @unique @db.Uuid
  scope     TestScope
  urls      String[] // Array of URLs for CUSTOM_URLS, empty for SITEMAP

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testRunId])
}

model UrlResult {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  testRunId String @db.Uuid
  url       String

  // Core Web Vitals (Performance only)
  lcp Float? // Largest Contentful Paint (seconds)
  cls Float? // Cumulative Layout Shift (score)
  inp Float? // Interaction to Next Paint (ms)
  fcp Float? // First Contentful Paint (seconds)
  tbt Float? // Total Blocking Time (ms)
  tti Float? // Time to Interactive (seconds)

  // Score (meaning depends on parent TestRun.type)
  score Int? // Calculated score (0-100)

  // Site Audit specific
  issueCount     Int? // Total issues for this URL
  criticalIssues Int? // Count of CRITICAL severity issues

  // Viewport/device (for Performance tests)
  viewport String? // "mobile" or "desktop"

  // Raw data
  additionalMetrics Json? // Provider-specific extras

  // Operational error (fetch failed, API error, etc.)
  error String? // If set, URL failed to process - no ResultItems created

  testRun     TestRun      @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  resultItems ResultItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testRunId])
  @@index([url])
}

model ResultItem {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  urlResultId     String         @db.Uuid
  provider        IssueProvider
  code            String         // Rule code (may or may not match a ReleaseRule)
  releaseRuleCode String?        // FK to ReleaseRule.code (only set for rules that exist)
  name            String         // Human-readable title of the check (fallback if no ReleaseRule)
  status          ResultStatus
  severity        IssueSeverity? // Only for FAIL status
  meta            Json?
  ignored         Boolean        @default(false) // User-marked as false positive

  urlResult   UrlResult    @relation(fields: [urlResultId], references: [id], onDelete: Cascade)
  releaseRule ReleaseRule? @relation(fields: [releaseRuleCode], references: [code])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([urlResultId])
  @@index([urlResultId, status])
  @@index([provider])
  @@index([status])
  @@index([severity])
  @@index([code])
  @@index([releaseRuleCode])
  @@index([ignored])
}

model ScreenshotSet {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  testRunId  String         @db.Uuid
  projectId  String         @db.Uuid
  url        String
  viewport   String
  storageKey String
  role       ScreenshotRole

  testRun TestRun @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([testRunId])
  @@index([url])
  @@index([role])
}

model ManualTestStatus {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  releaseRunId    String            @db.Uuid // Required - manual statuses are per Release Run
  projectId       String            @db.Uuid
  testType        ManualTestType
  statusLabel     ManualStatusLabel
  updatedByUserId String            @db.Uuid

  releaseRun ReleaseRun @relation(fields: [releaseRunId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id])
  updatedBy  User       @relation("ManualStatusUpdatedBy", fields: [updatedByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([releaseRunId])
  @@index([projectId, testType])
  @@index([updatedByUserId])
}

/// Categories for grouping ReleaseRules in the UI
model ReleaseRuleCategory {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique                // "Heading Structure", "Canonical", etc.
  description String?                         // Optional description of the category
  sortOrder   Int      @default(0)            // Display order in UI
  isActive    Boolean  @default(true)         // Soft enable/disable

  rules       ReleaseRule[]                   // All rules in this category

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sortOrder])
  @@index([isActive])
}

/// Taxonomy of all check rules - defines what each result code means
model ReleaseRule {
  code        String              @id         // Primary key - e.g., "PREFLIGHT_H1_MISSING"
  provider    IssueProvider                   // LIGHTHOUSE, LINKINATOR, ReleasePass, etc.
  categoryId  String              @db.Uuid    // FK to ReleaseRuleCategory
  name        String                          // Short title: "Missing H1 Heading"
  description String                          // What it means
  severity    IssueSeverity                   // Default severity: BLOCKER, CRITICAL, etc.
  impact      String?                         // Why it matters
  fix         String?                         // How to fix it
  docUrl      String?                         // External docs link
  isActive    Boolean             @default(true)   // Soft enable/disable
  isOptional  Boolean             @default(false)  // Optional rules are OFF by default per project
  sortOrder   Int                 @default(0)      // Display order within category

  category    ReleaseRuleCategory @relation(fields: [categoryId], references: [id])
  resultItems ResultItem[]                    // All result items using this rule

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provider])
  @@index([categoryId])
  @@index([isActive])
  @@index([isOptional])
}

/// Tracks which rules have been ignored by users for specific URLs
/// Used to auto-apply ignores on new test runs
model IgnoredRule {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String @db.Uuid
  url       String // The URL this ignore applies to
  code      String // The rule code to ignore (e.g., "document-title")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([projectId, url, code]) // One ignore per project/url/code combo
  @@index([projectId, url])
}

/// Tracks which optional rules are enabled for each project
/// Optional rules are OFF by default; this table stores enabled ones
model ProjectOptionalRule {
  id        String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String  @db.Uuid
  ruleCode  String  // References ReleaseRule.code (e.g., "EXTERNAL_LINK_TARGET")
  enabled   Boolean @default(true)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, ruleCode])
  @@index([projectId])
}
